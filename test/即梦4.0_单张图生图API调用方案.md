# 即梦4.0 单张图生图 API 调用技术方案

## 1. 接口概述

本文档基于提供的curl命令，详细说明如何使用Python调用即梦4.0的图像生成API。该API使用Bearer Token进行认证，通过POST请求生成高质量图像。

### 核心参数说明
- **接口地址**：`https://ark.cn-beijing.volces.com/api/v3/images/generations`
- **请求方法**：POST
- **认证方式**：Bearer Token
- **内容类型**：application/json

## 2. 环境准备

### 2.1 安装依赖

```bash
pip install requests
```

### 2.2 API密钥配置

从环境变量或配置文件中获取API密钥（Bearer Token）：

```python
# 从环境变量获取
import os
api_key = os.getenv('ARK_API_KEY')

# 或直接设置
api_key = "b6dafc52-e9dd-4d14-b221-1cba73bbe4fe"  # 替换为您的实际密钥
```

## 3. Python代码实现

### 3.1 完整代码

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
即梦4.0 单张图生图 API 调用脚本
基于 ark.cn-beijing.volces.com API 实现
"""

import json
import os
import sys
import requests
from typing import Dict, Any, Optional, Union

class ArkImageGenerator:
    """
    即梦4.0 图像生成器类
    封装图像生成API调用功能
    """
    
    def __init__(self, api_key: Optional[str] = None):
        """
        初始化图像生成器
        
        Args:
            api_key: Bearer Token API密钥，如果不提供则尝试从环境变量ARK_API_KEY获取
        
        Raises:
            ValueError: 当未提供API密钥且环境变量中也不存在时
        """
        self.api_key = api_key or os.getenv('ARK_API_KEY')
        self.api_url = "https://ark.cn-beijing.volces.com/api/v3/images/generations"
        
        if not self.api_key:
            raise ValueError("请提供API密钥或设置环境变量ARK_API_KEY")
        
        # 设置默认请求头
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}"
        }
    
    def generate_image(
        self,
        prompt: str,
        model: str = "doubao-seedream-4-0-250828",
        size: str = "2K",
        sequential_image_generation: str = "disabled",
        response_format: str = "url",
        stream: bool = False,
        watermark: bool = True,
        **kwargs
    ) -> Dict[str, Any]:
        """
        生成图像
        
        Args:
            prompt: 提示词，描述要生成的图像内容
            model: 使用的模型名称，默认 "doubao-seedream-4-0-250828"
            size: 图像尺寸，默认 "2K"
            sequential_image_generation: 顺序图像生成选项，默认 "disabled"
            response_format: 响应格式，默认 "url"
            stream: 是否流式响应，默认 False
            watermark: 是否添加水印，默认 True
            **kwargs: 其他可选参数
            
        Returns:
            包含生成图像信息的字典
            
        Raises:
            requests.exceptions.RequestException: HTTP请求错误
            ValueError: 参数验证失败
        """
        # 参数验证
        if not prompt or len(prompt.strip()) == 0:
            raise ValueError("提示词不能为空")
        
        # 构建请求体
        payload = {
            "model": model,
            "prompt": prompt,
            "sequential_image_generation": sequential_image_generation,
            "response_format": response_format,
            "size": size,
            "stream": stream,
            "watermark": watermark
        }
        
        # 添加额外参数
        payload.update(kwargs)
        
        # 发送请求
        try:
            response = requests.post(
                self.api_url,
                headers=self.headers,
                json=payload,
                timeout=60  # 设置超时时间
            )
            
            # 检查响应状态
            response.raise_for_status()
            
            # 返回解析后的JSON响应
            return response.json()
            
        except requests.exceptions.HTTPError as e:
            # 处理HTTP错误
            error_msg = f"HTTP错误: {e.response.status_code} - {e.response.text}"
            print(error_msg)
            raise
        except requests.exceptions.RequestException as e:
            # 处理其他网络错误
            error_msg = f"请求错误: {str(e)}"
            print(error_msg)
            raise
        except json.JSONDecodeError as e:
            # 处理JSON解析错误
            error_msg = f"JSON解析错误: {str(e)}"
            print(error_msg)
            raise

    def save_generated_image(
        self,
        image_url: str,
        save_path: str = "./generated_image.jpg"
    ) -> bool:
        """
        保存生成的图像到本地
        
        Args:
            image_url: 生成图像的URL
            save_path: 保存路径，默认 "./generated_image.jpg"
            
        Returns:
            bool: 保存成功返回True，否则返回False
        """
        try:
            response = requests.get(image_url, stream=True, timeout=30)
            response.raise_for_status()
            
            with open(save_path, 'wb') as file:
                for chunk in response.iter_content(chunk_size=8192):
                    file.write(chunk)
            
            print(f"图像已保存到: {save_path}")
            return True
            
        except Exception as e:
            print(f"保存图像失败: {str(e)}")
            return False


def main():
    """
    主函数，演示API调用示例
    """
    print("即梦4.0 单张图生图 API 调用演示")
    print("=" * 60)
    
    try:
        # 初始化生成器
        # 方式1: 使用环境变量中的API密钥
        # generator = ArkImageGenerator()
        
        # 方式2: 直接指定API密钥
        generator = ArkImageGenerator(api_key="b6dafc52-e9dd-4d14-b221-1cba73bbe4fe")
        
        # 准备提示词
        prompt = "星际穿越，黑洞，黑洞里冲出一辆快支离破碎的复古列车，抢视觉冲击力，电影大片，末日既视感，动感，对比色，oc渲染，光线追踪，动态模糊，景深，超现实主义，深蓝，画面通过细腻的丰富的色彩层次塑造主体与场景，质感真实，暗黑风背景的光影效果营造出氛围，整体兼具艺术幻想感，夸张的广角透视效果，耀光，反射，极致的光影，强引力，吞噬"
        
        print(f"\n提交图像生成请求...")
        print(f"使用模型: doubbao-seedream-4-0-250828")
        print(f"图像尺寸: 2K")
        
        # 生成图像
        result = generator.generate_image(
            prompt=prompt,
            size="2K",
            watermark=True
        )
        
        # 处理响应结果
        print("\nAPI 响应:")
        print(json.dumps(result, ensure_ascii=False, indent=2))
        
        # 如果成功获取图像URL，可以保存图像
        if "data" in result and result["data"]:
            image_url = result["data"][0].get("url")
            if image_url:
                print(f"\n生成的图像URL: {image_url}")
                # 保存图像示例
                # generator.save_generated_image(image_url, f"./generated_{int(time.time())}.jpg")
        
    except Exception as e:
        print(f"\n错误: {str(e)}")
        return 1
    
    return 0


if __name__ == "__main__":
    sys.exit(main())
```

### 3.2 代码说明

1. **类设计**：创建了 `ArkImageGenerator` 类封装API调用功能
2. **认证处理**：支持从环境变量或参数传入API密钥
3. **参数验证**：对必填参数进行基本验证
4. **错误处理**：捕获和处理各种可能的异常情况
5. **响应解析**：自动解析JSON响应数据
6. **图像保存**：提供保存生成图像的辅助方法

## 4. 参数说明

### 4.1 必需参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `prompt` | str | 图像生成的提示词，描述期望生成的图像内容 | - |

### 4.2 可选参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `model` | str | 使用的模型名称 | "doubao-seedream-4-0-250828" |
| `size` | str | 生成图像的尺寸，可选值如 "2K"、"1K" 等 | "2K" |
| `sequential_image_generation` | str | 顺序图像生成选项 | "disabled" |
| `response_format` | str | 响应格式，支持 "url" 或 "b64_json" | "url" |
| `stream` | bool | 是否使用流式响应 | False |
| `watermark` | bool | 是否在生成的图像上添加水印 | True |

### 4.3 提示词建议

- 描述详细具体，包含场景、风格、元素、色彩等
- 使用中文描述效果最佳
- 可以指定艺术风格、光线效果、构图特点
- 提示词长度建议在 100-500 字之间

## 5. 错误处理

### 5.1 常见错误类型

1. **认证错误**
   - 错误码: 401 Unauthorized
   - 原因: API密钥无效或过期
   - 解决方法: 检查API密钥是否正确

2. **请求参数错误**
   - 错误码: 400 Bad Request
   - 原因: 提示词为空或参数格式错误
   - 解决方法: 检查请求参数是否符合要求

3. **服务器错误**
   - 错误码: 5xx
   - 原因: 服务器临时问题
   - 解决方法: 稍后重试或联系API提供商

4. **请求超时**
   - 原因: 网络延迟或图像生成时间过长
   - 解决方法: 增加超时时间或分批处理

### 5.2 重试机制建议

对于临时性错误，可以实现指数退避重试机制：

```python
def generate_with_retry(generator, max_retries=3, **kwargs):
    """带重试机制的图像生成函数"""
    retries = 0
    while retries < max_retries:
        try:
            return generator.generate_image(**kwargs)
        except (requests.exceptions.HTTPError, requests.exceptions.Timeout) as e:
            retries += 1
            if retries >= max_retries:
                raise
            wait_time = min(2 ** retries, 30)  # 指数退避，最大30秒
            print(f"请求失败，{wait_time}秒后重试 ({retries}/{max_retries})...")
            time.sleep(wait_time)
```

## 6. 使用示例

### 6.1 基本用法

```python
from ark_image_generator import ArkImageGenerator

# 初始化生成器
generator = ArkImageGenerator(api_key="YOUR_API_KEY")

# 生成图像
result = generator.generate_image(
    prompt="一只可爱的小猫，油画风格，柔和的光线",
    size="2K",
    watermark=True
)

# 处理结果
if "data" in result and result["data"]:
    image_url = result["data"][0].get("url")
    print(f"生成的图像URL: {image_url}")
    # 保存图像
    generator.save_generated_image(image_url, "cat_oil_painting.jpg")
```

### 6.2 批量生成示例

```python
def batch_generate_images(prompts, save_dir="./generated_images"):
    """批量生成图像"""
    os.makedirs(save_dir, exist_ok=True)
    generator = ArkImageGenerator()
    
    results = []
    for i, prompt in enumerate(prompts):
        print(f"\n生成第 {i+1}/{len(prompts)} 张图像...")
        try:
            result = generator.generate_image(prompt=prompt)
            if "data" in result and result["data"]:
                image_url = result["data"][0].get("url")
                if image_url:
                    filename = f"image_{i+1}.jpg"
                    save_path = os.path.join(save_dir, filename)
                    generator.save_generated_image(image_url, save_path)
                    results.append({
                        "prompt": prompt,
                        "image_path": save_path,
                        "success": True
                    })
        except Exception as e:
            print(f"生成失败: {str(e)}")
            results.append({
                "prompt": prompt,
                "error": str(e),
                "success": False
            })
    
    return results

# 使用示例
prompts_list = [
    "现代城市夜景，霓虹灯，未来感",
    "雪山湖泊，自然风光，高清写实",
    "抽象艺术，色彩斑斓，毕加索风格"
]
results = batch_generate_images(prompts_list)
```

## 7. 最佳实践

### 7.1 API密钥安全

- 不要在代码中硬编码API密钥，优先使用环境变量
- 定期更换API密钥
- 限制API密钥的访问权限和使用范围

### 7.2 性能优化

- 对于批量生成任务，实现异步请求或多线程处理
- 缓存常用提示词和参数组合
- 合理设置超时时间和重试策略

### 7.3 提示词优化

- 逐步细化提示词，通过多次实验找到最佳描述方式
- 使用专业的艺术和摄影术语描述风格和效果
- 明确指定要包含和排除的元素

## 8. 注意事项

1. **API调用限制**：注意API的调用频率限制和配额
2. **费用问题**：使用API可能产生费用，注意监控使用量
3. **内容合规**：确保提示词和生成内容符合相关规定
4. **版本兼容**：API参数可能随版本更新而变化，请关注官方文档
5. **错误监控**：实现完善的日志记录和监控机制

## 9. 扩展功能建议

1. **Web界面**：构建简单的Web界面方便用户上传提示词和查看结果
2. **提示词模板库**：维护常用提示词模板，方便快速生成特定风格的图像
3. **历史记录**：记录生成历史，支持结果比较和参数优化
4. **图像处理**：集成后续图像处理功能，如裁剪、调整大小等

---

**作者**: AI Assistant  
**创建时间**: 2024  
**版本**: 1.0