# 图生图功能数据库设计

## 设计概述

基于现有的数据库结构和即梦4.0图生图API调用功能，设计数据库结构以支持图生图任务的存储、跟踪和管理。

## 现有数据库结构分析

当前项目已有的核心模型：

- `Photo` - 存储图片信息
- `Tag` - 存储标签信息
- `photo_tag` - 照片和标签的关联表

## 新增数据库表设计

### 1. 图片生成任务表（image_generation_task）

```sql
CREATE TABLE image_generation_task (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id VARCHAR(100) UNIQUE,
    input_image_url VARCHAR(1000) NOT NULL,
    prompt TEXT NOT NULL,
    model VARCHAR(100) DEFAULT 'doubao-seedream-4-0-250828',
    size VARCHAR(50) DEFAULT '2K',
    watermark BOOLEAN DEFAULT TRUE,
    status VARCHAR(50) DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME,
    error_message TEXT,
    api_response TEXT,
    FOREIGN KEY (input_image_id) REFERENCES photo(id)
);
```

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 任务ID（自增主键） |
| task_id | VARCHAR(100) | UNIQUE | 任务标识符（可用于API调用跟踪） |
| input_image_url | VARCHAR(1000) | NOT NULL | 输入图片的URL |
| input_image_id | INTEGER | FOREIGN KEY | 关联到Photo表的输入图片ID（可选） |
| prompt | TEXT | NOT NULL | 提示词 |
| model | VARCHAR(100) | DEFAULT 'doubao-seedream-4-0-250828' | 使用的模型名称 |
| size | VARCHAR(50) | DEFAULT '2K' | 图像尺寸 |
| watermark | BOOLEAN | DEFAULT TRUE | 是否添加水印 |
| status | VARCHAR(50) | DEFAULT 'pending' | 任务状态（pending, processing, completed, failed） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| completed_at | DATETIME | NULL | 完成时间 |
| error_message | TEXT | NULL | 错误信息（如有） |
| api_response | TEXT | NULL | API原始响应JSON |

### 2. 生成结果表（generation_result）

```sql
CREATE TABLE generation_result (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    generated_image_id INTEGER,
    generated_image_url VARCHAR(1000) NOT NULL,
    model VARCHAR(100),
    content_type VARCHAR(50),
    file_size INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES image_generation_task(id),
    FOREIGN KEY (generated_image_id) REFERENCES photo(id)
);
```

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 结果ID（自增主键） |
| task_id | INTEGER | NOT NULL, FOREIGN KEY | 关联到生成任务ID |
| generated_image_id | INTEGER | FOREIGN KEY | 关联到Photo表的生成图片ID（如果保存到了Photo表） |
| generated_image_url | VARCHAR(1000) | NOT NULL | 生成图片的URL |
| model | VARCHAR(100) | NULL | 实际使用的模型名称 |
| content_type | VARCHAR(50) | NULL | 图像内容类型 |
| file_size | INTEGER | NULL | 文件大小（字节） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 生成时间 |

### 3. 生成参数表（generation_parameter）

```sql
CREATE TABLE generation_parameter (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    parameter_name VARCHAR(100) NOT NULL,
    parameter_value TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES image_generation_task(id),
    UNIQUE(task_id, parameter_name)
);
```

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 参数ID（自增主键） |
| task_id | INTEGER | NOT NULL, FOREIGN KEY | 关联到生成任务ID |
| parameter_name | VARCHAR(100) | NOT NULL | 参数名称 |
| parameter_value | TEXT | NULL | 参数值 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## SQLAlchemy模型定义

```python
from datetime import datetime
from . import db

class ImageGenerationTask(db.Model):
    """图片生成任务模型"""
    __tablename__ = 'image_generation_task'
    
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    task_id = db.Column(db.String(100), unique=True, index=True)
    input_image_url = db.Column(db.String(1000), nullable=False)
    input_image_id = db.Column(db.Integer, db.ForeignKey('photo.id'))
    prompt = db.Column(db.Text, nullable=False)
    model = db.Column(db.String(100), default='doubao-seedream-4-0-250828')
    size = db.Column(db.String(50), default='2K')
    watermark = db.Column(db.Boolean, default=True)
    status = db.Column(db.String(50), default='pending', index=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow, index=True)
    completed_at = db.Column(db.DateTime)
    error_message = db.Column(db.Text)
    api_response = db.Column(db.Text)
    
    # 关系
    results = db.relationship('GenerationResult', back_populates='task', cascade='all, delete-orphan')
    parameters = db.relationship('GenerationParameter', back_populates='task', cascade='all, delete-orphan')
    input_image = db.relationship('Photo', foreign_keys=[input_image_id])

class GenerationResult(db.Model):
    """生成结果模型"""
    __tablename__ = 'generation_result'
    
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    task_id = db.Column(db.Integer, db.ForeignKey('image_generation_task.id'), nullable=False)
    generated_image_id = db.Column(db.Integer, db.ForeignKey('photo.id'))
    generated_image_url = db.Column(db.String(1000), nullable=False)
    model = db.Column(db.String(100))
    content_type = db.Column(db.String(50))
    file_size = db.Column(db.Integer)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # 关系
    task = db.relationship('ImageGenerationTask', back_populates='results')
    generated_image = db.relationship('Photo', foreign_keys=[generated_image_id])

class GenerationParameter(db.Model):
    """生成参数模型"""
    __tablename__ = 'generation_parameter'
    
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    task_id = db.Column(db.Integer, db.ForeignKey('image_generation_task.id'), nullable=False)
    parameter_name = db.Column(db.String(100), nullable=False)
    parameter_value = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # 关系
    task = db.relationship('ImageGenerationTask', back_populates='parameters')
    
    __table_args__ = (
        db.UniqueConstraint('task_id', 'parameter_name', name='_task_parameter_uc'),
    )
```

## ER图描述

```
+---------------+         +-------------------+         +------------------+
|               |         |                   |         |                  |
|     Photo     |<--------| image_generation_ |-------->| generation_      |
|               |         |       task        |         |    result        |
+---------------+         +-------------------+         +------------------+
        ^                          |
        |                          |
        |                          v
        |                   +------------------+
        |                   |                  |
        +-------------------| generation_      |
                            |    parameter     |
                            +------------------+
```

### 关系说明

1. **Photo 与 image_generation_task**: 
   - 一对多关系：一个Photo可以作为多个生成任务的输入图片

2. **image_generation_task 与 generation_result**:
   - 一对多关系：一个生成任务可以产生多个生成结果（如果API支持批量生成）

3. **image_generation_task 与 generation_parameter**:
   - 一对多关系：一个生成任务可以有多个参数配置

4. **generation_result 与 Photo**:
   - 一对一关系：一个生成结果可以关联到一个保存的Photo记录

## 功能扩展建议

1. **用户关联**：如果系统支持多用户，可以添加用户ID字段关联到生成任务
2. **收藏功能**：添加收藏表记录用户收藏的生成结果
3. **评价系统**：添加评价表收集用户对生成结果的反馈
4. **使用统计**：添加API调用统计表跟踪API使用情况和配额

## 索引优化建议

```sql
-- 为常用查询字段添加索引
CREATE INDEX idx_task_status ON image_generation_task(status);
CREATE INDEX idx_task_created ON image_generation_task(created_at);
CREATE INDEX idx_task_completed ON image_generation_task(completed_at);
CREATE INDEX idx_result_created ON generation_result(created_at);
CREATE INDEX idx_task_model ON image_generation_task(model);
```

## 使用示例

### 保存生成任务

```python
# 创建生成任务
task = ImageGenerationTask(
    input_image_url="https://example.com/sample.jpg",
    prompt="将图片转换为油画风格",
    model="doubao-seedream-4-0-250828",
    size="2K",
    watermark=True,
    status="processing"
)
db.session.add(task)
db.session.commit()

# 添加额外参数
param1 = GenerationParameter(
    task_id=task.id,
    parameter_name="sequential_image_generation",
    parameter_value="disabled"
)
param2 = GenerationParameter(
    task_id=task.id,
    parameter_name="response_format",
    parameter_value="url"
)
db.session.add_all([param1, param2])
db.session.commit()

# 更新任务状态和结果
task.status = "completed"
task.completed_at = datetime.utcnow()
task.api_response = json.dumps(api_response)

# 添加生成结果
result = GenerationResult(
    task_id=task.id,
    generated_image_url=api_response["data"][0]["url"],
    model=api_response["data"][0]["model"]
)
db.session.add(result)
db.session.commit()
```

---

此数据库设计支持完整的图生图功能记录、跟踪和管理，同时保持与现有系统的兼容性。