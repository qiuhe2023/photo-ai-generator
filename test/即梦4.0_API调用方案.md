# 即梦 4.0 API 调用技术方案

## 前置说明（必读）

以下内容为直接使用 HTTP 方式调用接口的请求示例(包含签名过程)，替换关键信息即可直接调用。

### Step1(必需): 通过火山访问控制获取 AK/SK

- 需确保火山账号已开通对应权限和相关策略
- 正确替换示例中的 AccessKeyID 和 SecretAccessKey 参数值
- 无权限情况下会报错

### Step2(大多数情况下可跳过): 查看接口文档请求参数-Query 参数

- 正确替换示例中的 action 和 version 参数值

### Step3(必需): 查看接口文档请求参数-Body 参数

- 将请求示例内容复制到调用示例的 body 入参部分
- 正确替换示例中的 Body 入参

### Step4: 运行程序进行调试

- 待测试调通后，可以按需集成到项目中
- 不建议直接 Copy，建议自行适配或更新包

## 1. 接口概述

即梦 4.0 是火山引擎提供的图像生成 API，集成了文生图、图像编辑及多图组合生成功能，支持 4K 超高清输出，为专业图像创作提供一站式解决方案。

## 2. 环境准备

### 2.1 安装依赖

```bash
pip install requests
```

### 2.2 获取访问凭证

在火山引擎控制台获取以下凭证：

- Access Key
- Secret Key

## 3. API 调用代码实现

### 3.1 完整代码示例

```python
import json
import sys
import os
import datetime
import hashlib
import hmac
import requests

# 接口配置
method = 'POST'
host = 'visual.volcengineapi.com'
region = 'cn-north-1'
endpoint = 'https://visual.volcengineapi.com'
service = 'cv'

# HMAC签名相关函数
def sign(key, msg):
    return hmac.new(key, msg.encode('utf-8'), hashlib.sha256).digest()

def getSignatureKey(key, dateStamp, regionName, serviceName):
    kDate = sign(key.encode('utf-8'), dateStamp)
    kRegion = sign(kDate, regionName)
    kService = sign(kRegion, serviceName)
    kSigning = sign(kService, 'request')
    return kSigning

# 格式化查询参数
def formatQuery(parameters):
    request_parameters_init = ''
    for key in sorted(parameters):
        request_parameters_init += key + '=' + parameters[key] + '&'
    request_parameters = request_parameters_init[:-1]
    return request_parameters

# 生成V4签名请求
def signV4Request(access_key, secret_key, service, req_query, req_body):
    if access_key is None or secret_key is None:
        print('No access key is available.')
        sys.exit()

    # 获取当前时间
    t = datetime.datetime.utcnow()
    current_date = t.strftime('%Y%m%dT%H%M%SZ')
    datestamp = t.strftime('%Y%m%d')  # 用于凭证范围的日期

    # 构建规范化请求
    canonical_uri = '/'
    canonical_querystring = req_query
    signed_headers = 'content-type;host;x-content-sha256;x-date'
    payload_hash = hashlib.sha256(req_body.encode('utf-8')).hexdigest()
    content_type = 'application/json'
    canonical_headers = 'content-type:' + content_type + '\n' + 'host:' + host + \
        '\n' + 'x-content-sha256:' + payload_hash + \
        '\n' + 'x-date:' + current_date + '\n'
    canonical_request = method + '\n' + canonical_uri + '\n' + canonical_querystring + \
        '\n' + canonical_headers + '\n' + signed_headers + '\n' + payload_hash

    # 构建签名字符串
    algorithm = 'HMAC-SHA256'
    credential_scope = datestamp + '/' + region + '/' + service + '/' + 'request'
    string_to_sign = algorithm + '\n' + current_date + '\n' + credential_scope + '\n' + hashlib.sha256(
        canonical_request.encode('utf-8')).hexdigest()

    # 计算签名
    signing_key = getSignatureKey(secret_key, datestamp, region, service)
    signature = hmac.new(signing_key, (string_to_sign).encode(
        'utf-8'), hashlib.sha256).hexdigest()

    # 构建授权头
    authorization_header = algorithm + ' ' + 'Credential=' + access_key + '/' + \
        credential_scope + ', ' + 'SignedHeaders=' + \
        signed_headers + ', ' + 'Signature=' + signature

    # 请求头
    headers = {
        'X-Date': current_date,
        'Authorization': authorization_header,
        'X-Content-Sha256': payload_hash,
        'Content-Type': content_type
    }

    # 发送请求
    request_url = endpoint + '?' + canonical_querystring

    print('\nBEGIN REQUEST++++++++++++++++++++++++++++++++++++')
    print('Request URL = ' + request_url)
    try:
        r = requests.post(request_url, headers=headers, data=req_body)
        r.raise_for_status()  # 检查是否有HTTP错误
    except requests.exceptions.RequestException as err:
        print(f'Error occurred: {err}')
        raise
    else:
        print('\nRESPONSE++++++++++++++++++++++++++++++++++++')
        print(f'Response code: {r.status_code}\n')
        # 使用 replace 方法将 \u0026 替换为 &
        resp_str = r.text.replace("\\u0026", "&")
        print(f'Response body: {resp_str}\n')
        # 返回解析后的响应
        return json.loads(resp_str)

# 即梦4.0 API调用函数
def call_jimeng_api(access_key, secret_key, prompt, image_urls=None, size=None, width=None, height=None,
                   scale=0.5, force_single=False, min_ratio=1/3, max_ratio=3):
    """
    调用即梦4.0 API生成图像

    参数:
    - access_key: 访问密钥
    - secret_key: 密钥
    - prompt: 提示词，最长不超过800字符
    - image_urls: 可选，图片URL列表，最多10张
    - size: 可选，生图面积，默认4194304(2048*2048)
    - width: 可选，图像宽度（与height同时使用）
    - height: 可选，图像高度（与width同时使用）
    - scale: 可选，文本描述影响程度，默认0.5
    - force_single: 可选，是否强制生成单图，默认False
    - min_ratio: 可选，最小宽高比，默认1/3
    - max_ratio: 可选，最大宽高比，默认3

    返回:
    - 解析后的API响应
    """
    # 请求Query参数
    query_params = {
        'Action': 'CVSync2AsyncSubmitTask',
        'Version': '2022-08-31',
    }
    formatted_query = formatQuery(query_params)

    # 请求Body参数
    body_params = {
        "req_key": "jimeng_t2i_v40",  # 即梦4.0服务标识
        "prompt": prompt,
        "scale": scale,
        "force_single": force_single,
        "min_ratio": min_ratio,
        "max_ratio": max_ratio
    }

    # 添加可选参数
    if image_urls:
        body_params["image_urls"] = image_urls

    if size:
        body_params["size"] = size

    if width and height:
        body_params["width"] = width
        body_params["height"] = height

    formatted_body = json.dumps(body_params)

    # 调用API
    return signV4Request(access_key, secret_key, service, formatted_query, formatted_body)

# 示例调用
if __name__ == "__main__":
    # 请求凭证（请替换为实际值）
    access_key = 'YOUR_ACCESS_KEY'
    secret_key = 'YOUR_SECRET_KEY'

    # 文生图示例
    result = call_jimeng_api(
        access_key=access_key,
        secret_key=secret_key,
        prompt="一只可爱的柯基犬在草地上玩耍",
        size=4194304,  # 2K分辨率
        force_single=True
    )

    # 处理响应
    if 'TaskId' in result:
        print(f"任务提交成功，任务ID: {result['TaskId']}")
        # 后续可以通过TaskId查询结果
    else:
        print(f"任务提交失败: {result.get('Error', 'Unknown error')}")
```

## 4. 参数说明

### 4.1 必需参数

| 参数名  | 类型   | 说明                                  |
| ------- | ------ | ------------------------------------- |
| req_key | string | 服务标识，固定值: jimeng_t2i_v40      |
| prompt  | string | 生成图像的提示词，最长不超过 800 字符 |

### 4.2 可选参数

| 参数名       | 类型            | 说明                                                | 默认值             |
| ------------ | --------------- | --------------------------------------------------- | ------------------ |
| image_urls   | array of string | 图片 URL 列表，最多 10 张                           | 无                 |
| size         | int             | 生图面积（宽 × 高），取值范围[1024×1024, 4096×4096] | 4194304(2048×2048) |
| width        | int             | 图像宽度（需与 height 同时使用）                    | 无                 |
| height       | int             | 图像高度（需与 width 同时使用）                     | 无                 |
| scale        | float           | 文本描述影响程度，值越大文本影响越大                | 0.5                |
| force_single | bool            | 是否强制生成单图                                    | False              |
| min_ratio    | float           | 最小宽高比(宽/高)                                   | 1/3                |
| max_ratio    | float           | 最大宽高比(宽/高)                                   | 3                  |

## 5. 响应处理

API 响应包含以下主要字段：

```json
{
  "ResponseMetadata": {
    "RequestId": "20251122125632C2F5E590C119678DDDF2",
    "Action": "CVSync2AsyncSubmitTask",
    "Version": "2022-08-31"
  },
  "Result": {
    "TaskId": "task123456789"
  }
}
```

### 5.1 错误处理

常见错误码：

| 错误码           | 说明         | 解决方法                               |
| ---------------- | ------------ | -------------------------------------- |
| MissingParameter | 缺少必要参数 | 检查并补充缺失的参数                   |
| InvalidParameter | 参数值无效   | 检查参数格式和取值范围                 |
| Unauthorized     | 未授权访问   | 检查 Access Key 和 Secret Key 是否正确 |

## 6. 最佳实践

1. **凭证管理**：避免在代码中硬编码凭证，建议使用环境变量或配置文件
2. **错误处理**：实现完善的异常捕获和错误重试机制
3. **异步处理**：考虑 API 的异步特性，使用 TaskId 轮询获取最终结果
4. **图片数量控制**：建议输入图片控制在 6 张以内，避免效果降低
5. **分辨率选择**：建议生成 2K 以上分辨率图片，以获得更好的效果
6. **并发控制**：根据 API 限额合理控制并发请求数量

## 7. 注意事项

1. 单次调用最多支持 10 张输入图像，最多输出 15 张图像
2. 输入图片格式仅支持 JPEG、PNG，最大 15MB
3. 图片分辨率最大为 4096×4096
4. 输入图宽高比范围为[1/3, 3]
5. 输出图像数量和分辨率会影响 API 调用延迟
6. 如对延迟敏感，建议设置 force_single=true 强制生成单图

## 8. 完整调用流程

1. 准备访问凭证（Access Key、Secret Key）
2. 构建请求参数（Query 和 Body）
3. 生成 V4 签名
4. 发送 HTTP 请求
5. 处理响应，获取 TaskId
6. 根据 TaskId 查询任务结果（需实现查询逻辑）

## 9. 扩展功能

### 9.1 任务结果查询示例

```python
def query_task_result(access_key, secret_key, task_id):
    """
    查询任务执行结果
    """
    # 请求Query参数
    query_params = {
        'Action': 'CVSync2AsyncGetResult',
        'Version': '2022-08-31',
    }
    formatted_query = formatQuery(query_params)

    # 请求Body参数
    body_params = {
        "task_id": task_id
    }
    formatted_body = json.dumps(body_params)

    # 调用API
    return signV4Request(access_key, secret_key, service, formatted_query, formatted_body)

# 轮询查询结果示例
def poll_task_result(access_key, secret_key, task_id, max_retries=30, interval=5):
    """
    轮询查询任务结果
    - max_retries: 最大重试次数
    - interval: 轮询间隔（秒）
    """
    import time

    for i in range(max_retries):
        result = query_task_result(access_key, secret_key, task_id)
        status = result.get('Result', {}).get('Status')

        if status == 'Success':
            return result
        elif status == 'Failed':
            raise Exception(f"Task failed: {result.get('Result', {}).get('ErrorMessage')}")

        print(f"Polling task status (attempt {i+1}/{max_retries})...")
        time.sleep(interval)

    raise TimeoutError("Task polling timed out")
```

---

_注：本方案基于火山引擎即梦 4.0 API 接口文档和提供的 Python 示例代码编写，使用前请确保已申请并获取有效的 API 访问凭证。_
